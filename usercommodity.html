<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>User Commodity & Price Monitoring</title>
<style>
:root {
  --text: #111111;
  --blue: #0a53c1;
  --ink-20: #f4f6f8;
  --white: #ffffff;
  --border: #e6e8eb;
  --shadow: 0 6px 24px rgba(0, 0, 0, .06);
}

* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: Inter, system-ui, sans-serif;
  background: var(--white);
  color: var(--text);
}
.app { display: grid; grid-template-columns: 240px 1fr; min-height: 100vh; }

.sidebar {
  border-right: 1px solid var(--border);
  background: #4e73df; 
}
.brand {
  font-weight: 800;
  text-transform: uppercase;
  padding: 1rem;
  border-bottom: 1px solid var(--border);
}
nav { padding: 1rem; }
.nav-item {
  display: block; padding: .6rem;
  border-radius: 8px; text-decoration: none; color: var(--text);
}
.nav-item:hover, .nav-item.active { background: var(--ink-20); }

.main { display: grid; grid-template-rows: 64px 1fr; min-width: 0; }
.topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 1rem; border-bottom: 1px solid var(--border);
}
.btn {
  border: 1px solid var(--text);
  background: transparent; padding: .4rem .8rem;
  border-radius: 8px; cursor: pointer;
}
.content { padding: 1rem; overflow: auto; }

table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
th, td {
  border-bottom: 1px solid var(--border);
  padding: .6rem; text-align: left;
}
th { font-size: .85rem; opacity: .7; }

.card { border:1px solid var(--border); border-radius:12px; padding:1rem; box-shadow: var(--shadow); background:#fff; flex:1;}
.select { padding:.5rem; border-radius:8px; border:1px solid var(--border);}
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:#fff; padding:1.5rem; border-radius:12px; width:400px; box-shadow:var(--shadow);}
.modal h2 { margin-top:0; margin-bottom:.5rem; }
.modal table { width:100%; border-collapse:collapse; }
.modal td { padding:.3rem; border-bottom:1px solid #ddd; }
.close { float:right; cursor:pointer; font-weight:bold;}
  .main-layout {
  display: grid;
  grid-template-columns: 1.2fr 0.8fr;
  gap: 1.5rem;
  align-items: start;
}

.chart-section {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.table-section {
  display: flex;
  flex-direction: column;
}

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">LGU 3 USER SYSTEM</div>
    <nav>
      <a href="userdashboard.html" class="nav-item">Dashboard</a>
      <a href="uservendor.html" class="nav-item">Vendor Management</a>
      <a href="usercommodity.html" class="nav-item active">Commodity & Price Monitoring</a>
      <a href="usersupply.html" class="nav-item">Supply Monitoring</a>
      <a href="userinspection.html" class="nav-item">Inspection & Compliance</a>
      <a href="userreports.html" class="nav-item">Reports & Analytics</a>
      <a href="usersettings.html" class="nav-item">Settings</a>
      <a href="login.html" class="nav-item" style="margin-top:2rem; font-weight:bold;">Logout</a>
    </nav>
  </aside>

<section class="main">
  <header class="topbar">
  <div style="display:flex; align-items:center; gap:0.8rem;">
    <button class="btn" id="backBtn">← Back</button>
    <h2>COMMODITY & PRICE MONITORING</h2>
  </div>
  <button class="btn" id="exportBtn">Export</button>
</header>
   
<div class="content">
  <div class="main-layout">
   
    <div class="card chart-section">
      <h3>Commodity Prices (Average PHP)</h3>
      <canvas id="commodityChart" height="300"></canvas>
    </div>

  
   <div class="card table-section">
  <div class="table-header">
    <h3>Commodity Table</h3>
  </div>
  <div style="margin-top: 1rem; display: flex; justify-content: center;">
    <select id="commoditySelect" class="select">
      <option value="">-- Choose Category --</option>
      <option value="meat">Meat</option>
      <option value="fish">Fish</option>
      <option value="fruits">Fruits</option>
      <option value="vegetables">Vegetables</option>
      <option value="others">Others</option>
    </select>
  </div>
</div>

     <table id="commodityTable" style="display:none;">
        <tbody></tbody>
       </table>
    </div>
  </div>
</div>
</section>
</div>

<div class="modal" id="priceModal">
  <div class="modal-content">
    <span class="close" id="closeModal">×</span>
    <h2 id="modalTitle"></h2>
    <table id="priceTable"></table>
  </div>
</div>

<script>
const userData = JSON.parse(localStorage.getItem("commodityData"));
console.log("User Commodity Data:", userData);
  
  meat: [
    { name: "Pork", current: "₱320-250/kg", previous: "₱300-230/kg" },
    { name: "Beef", current: "₱380-450/kg", previous: "₱360-430/kg" },
    { name: "Chicken", current: "₱210/kg", previous: "₱200/kg" }
  ],
  fish: [
    { name: "Bangus", current: "₱200/kg", previous: "₱180/kg" },
    { name: "Tilapia", current: "₱100/kg", previous: "₱90/kg" },
    { name: "Galunggung", current: "₱200/kg", previous: "₱190/kg" }
  ],
  fruits: [
    { name: "Banana", current: "₱50/kg", previous: "₱45/kg" },
    { name: "Mango", current: "₱200/kg", previous: "₱180/kg" },
    { name: "Apple", current: "₱150/kg", previous: "₱140/kg" }
  ],
  vegetables: [
    { name: "Cabbage", current: "₱50/kg", previous: "₱45/kg" },
    { name: "Carrots", current: "₱150/kg", previous: "₱140/kg" },
    { name: "Potatoes", current: "₱200/kg", previous: "₱180/kg" },
    { name: "Tomatoes", current: "₱100/kg", previous: "₱90/kg" }
  ],
  others: [
    { name: "Egg", current: "₱200/12pcs", previous: "₱180/12pcs" },
    { name: "Onion", current: "₱100/kg", previous: "₱90/kg" },
    { name: "Garlic", current: "₱200/kg", previous: "₱180/kg" }
  ]
};


function extractAverage(value) {
  const nums = value.match(/\d+/g);
  if (!nums) return 0;
  if (nums.length === 2) return (parseInt(nums[0]) + parseInt(nums[1])) / 2;
  return parseInt(nums[0]);
}

function computeAverages(type) {
  return Object.keys(commodityData).map(category => {
    const items = commodityData[category];
    const values = items.map(i => extractAverage(i[type]));
    const avg = values.reduce((a, b) => a + b, 0) / values.length;
    return Math.round(avg);
  });
}


const categories = Object.keys(commodityData).map(
  c => c.charAt(0).toUpperCase() + c.slice(1)
);

const ctx = document.getElementById("commodityChart").getContext("2d");
let chart = new Chart(ctx, {
  type: "bar",
  data: {
    labels: categories,
    datasets: [
      {
        label: "Current Price (PHP)",
        data: computeAverages("current"),
        backgroundColor: "#0a53c1"
      },
      {
        label: "Previous Price (PHP)",
        data: computeAverages("previous"),
        backgroundColor: "#94b3ff"
      }
    ]
  },
  options: {
    responsive: true,
    scales: {
      y: {
        beginAtZero: true,
        title: { display: true, text: "Average Price (PHP)" }
      }
    },
    plugins: { legend: { position: "top" } }
  }
});


const select = document.getElementById("commoditySelect");
const modal = document.getElementById("priceModal");
const modalTitle = document.getElementById("modalTitle");
const priceTable = document.getElementById("priceTable");
const closeModal = document.getElementById("closeModal");

select.addEventListener("change", () => {
  const value = select.value;
  if (!value) return;
  modalTitle.textContent = value.charAt(0).toUpperCase() + value.slice(1);
  priceTable.innerHTML = "";

  commodityData[value].forEach((item, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item.name}</td>
      <td>Current: ${item.current}</td>
      <td>Previous: ${item.previous}</td>
      <td><button class="btn editBtn" data-cat="${value}" data-index="${index}">Edit</button></td>
    `;
    priceTable.appendChild(row);
  });

  modal.style.display = "flex";
});


  localStorage.setItem("commodityData", JSON.stringify(commodityData));


  e.target.closest("tr").children[1].textContent = `Current: ${newCurrent}`;
  e.target.closest("tr").children[2].textContent = `Previous: ${newPrevious}`;

  chart.data.datasets[0].data = computeAverages("current");
  chart.data.datasets[1].data = computeAverages("previous");
  chart.update();
});

closeModal.addEventListener("click", () => (modal.style.display = "none"));
window.addEventListener("click", e => {
  if (e.target === modal) modal.style.display = "none";
});
document.getElementById("backBtn").addEventListener("click", () => window.history.back());
</script>
